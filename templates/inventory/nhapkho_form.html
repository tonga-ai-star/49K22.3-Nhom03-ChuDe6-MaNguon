{% extends 'base.html' %}
{% load static %}

{% block title %}T·∫°o phi·∫øu nh·∫≠p kho{% endblock %}
{% block page_title %}üì• T·∫°o phi·∫øu nh·∫≠p kho{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>Th√¥ng tin phi·∫øu nh·∫≠p
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="nhapKhoForm">
                    {% csrf_token %}

                    <!-- Th√¥ng tin c∆° b·∫£n -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label fw-bold">Kho nh·∫≠p <span class="text-danger">*</span></label>
                                <select name="kho_id" class="form-control" required>
                                    <option value="">-- Ch·ªçn kho --</option>
                                    {% if kho_list %}
                                        {% for kho in kho_list %}
                                            <option value="{{ kho.id }}">{{ kho.ten_kho }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label fw-bold">Nh√† cung c·∫•p <span class="text-danger">*</span></label>
                                <select name="nha_cung_cap_id" class="form-control" required>
                                    <option value="">-- Ch·ªçn nh√† cung c·∫•p --</option>
                                    {% for ncc in nha_cung_cap_list %}
                                        <option value="{{ ncc.id }}">{{ ncc.ten_nha_cung_cap }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" name="nha_cung_cap_moi" class="form-control mt-2"
                                       placeholder="Ho·∫∑c nh·∫≠p t√™n nh√† cung c·∫•p m·ªõi">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label fw-bold">M√£ phi·∫øu</label>
                                <input type="text" class="form-control" value="T·ª± ƒë·ªông" disabled>
                                <small class="text-muted">M√£ phi·∫øu s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông</small>
                            </div>
                        </div>
                    </div>

                    <!-- Ghi ch√∫ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="form-group">
                                <label class="form-label fw-bold">Ghi ch√∫</label>
                                {{ form.ghi_chu }}
                            </div>
                        </div>
                    </div>

                    <!-- Header c·ªßa b·∫£ng chi ti·∫øt -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold">
                            <i class="fas fa-boxes me-2"></i>Chi ti·∫øt s·∫£n ph·∫©m
                        </h6>
                        <button type="button" class="btn btn-success btn-sm" id="addProduct">
                            <i class="fas fa-plus me-1"></i>Th√™m s·∫£n ph·∫©m
                        </button>
                    </div>

                    <div class="row mb-2 fw-bold text-muted small">
                        <div class="col-md-3">S·∫£n ph·∫©m <span class="text-danger">*</span></div>
                        <div class="col-md-2">Danh m·ª•c</div>
                        <div class="col-md-2">ƒê∆°n v·ªã t√≠nh</div>
                        <div class="col-md-2">S·ªë l∆∞·ª£ng</div>
                        <div class="col-md-2">ƒê∆°n gi√° (‚Ç´)</div>
                        <div class="col-md-1 text-center">X√≥a</div>
                    </div>

                    <!-- Chi ti·∫øt s·∫£n ph·∫©m -->
                    <div id="productDetails">
                        <div class="product-row row mb-3 align-items-center border-bottom pb-3">
                            <div class="col-md-3">
                                <input type="text" name="ten_san_pham" class="form-control ten-san-pham"
                                       placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." list="sanPhamList" required>
                                <datalist id="sanPhamList">
                                    {% for sp in san_pham_list %}
                                    <option value="{{ sp.ten_san_pham }}"
                                            data-danhmuc="{{ sp.danh_muc.ten_danh_muc }}"
                                            data-donvitinh="{{ sp.don_vi_tinh.ten_don_vi }}"
                                            data-gianhap="{{ sp.gia_nhap|default:0 }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                            <div class="col-md-2">
                                <input type="text" name="danh_muc" class="form-control danh-muc-input" readonly>
                            </div>
                            <div class="col-md-2">
                                <input type="text" name="don_vi_tinh" class="form-control don-vi-tinh-input" readonly>
                            </div>
                            <div class="col-md-2">
                                <input type="number" name="so_luong" class="form-control so-luong"
                                       placeholder="SL" min="1" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-2">
                                <input type="number" name="don_gia" class="form-control don-gia"
                                       placeholder="ƒê∆°n gi√°" step="0.01" min="0" required
                                       onchange="calculateTotal()">
                            </div>
                            <div class="col-md-1 text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-product" disabled title="X√≥a d√≤ng">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- T·ªïng ti·ªÅn -->
                    <div class="row mb-4">
                        <div class="col-md-4 offset-md-8">
                            <div class="card bg-light border">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong class="fs-5">T·ªïng c·ªông:</strong>
                                        <strong class="fs-4 text-success" id="grandTotal">0‚Ç´</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- N√∫t h√†nh ƒë·ªông -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-save me-2"></i>L∆∞u phi·∫øu nh·∫≠p
                        </button>
                        <a href="{% url 'inventory:nhapkho_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>H·ªßy
                        </a>
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-2"></i>L√†m m·ªõi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('addProduct');
    const productDetails = document.getElementById('productDetails');

    // Th√™m d√≤ng s·∫£n ph·∫©m m·ªõi
    addBtn.addEventListener('click', function() {
        const newRow = document.querySelector('.product-row').cloneNode(true);
        const inputs = newRow.querySelectorAll('input');
        inputs.forEach(input => {
            input.value = '';
            input.removeAttribute('disabled');
        });
        newRow.querySelector('.remove-product').removeAttribute('disabled');
        productDetails.appendChild(newRow);
    });

    // X√≥a d√≤ng s·∫£n ph·∫©m
    productDetails.addEventListener('click', function(e) {
        if (e.target.closest('.remove-product')) {
            if (document.querySelectorAll('.product-row').length > 1) {
                e.target.closest('.product-row').remove();
                calculateTotal();
            }
        }
    });

    // T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin khi ch·ªçn s·∫£n ph·∫©m t·ª´ datalist
    productDetails.addEventListener('input', function(e) {
        if (e.target.classList.contains('ten-san-pham')) {
            const productName = e.target.value;
            const row = e.target.closest('.product-row');
            const danhMucInput = row.querySelector('.danh-muc-input');
            const donViTinhInput = row.querySelector('.don-vi-tinh-input');
            const donGiaInput = row.querySelector('.don-gia');

            if (productName) {
                // T√¨m s·∫£n ph·∫©m trong datalist
                const datalist = document.getElementById('sanPhamList');
                const options = datalist.options;
                let foundProduct = null;

                for (let option of options) {
                    if (option.value === productName) {
                        foundProduct = option;
                        break;
                    }
                }

                if (foundProduct && foundProduct.dataset.id) {
                    // T·ª± ƒë·ªông ƒëi·ªÅn danh m·ª•c, ƒë∆°n v·ªã t√≠nh, gi√° nh·∫≠p
                    const danhMuc = foundProduct.dataset.danhmuc;
                    const donViTinh = foundProduct.dataset.donvitinh;
                    const giaNhap = foundProduct.dataset.gianhap;

                    if (danhMuc && !danhMucInput.value) {
                        danhMucInput.value = danhMuc;
                    }

                    if (donViTinh && !donViTinhInput.value) {
                        donViTinhInput.value = donViTinh;
                    }

                    if (giaNhap && !donGiaInput.value) {
                        donGiaInput.value = giaNhap;
                    }
                }

                calculateTotal();
            }
        }
    });

    // T√≠nh to√°n t·ªïng ti·ªÅn
    window.calculateTotal = function() {
        let grandTotal = 0;
        document.querySelectorAll('.product-row').forEach(row => {
            const quantity = parseFloat(row.querySelector('.so-luong').value) || 0;
            const price = parseFloat(row.querySelector('.don-gia').value) || 0;
            const total = quantity * price;
            grandTotal += total;
        });
        document.getElementById('grandTotal').textContent = grandTotal.toLocaleString('vi-VN') + '‚Ç´';
    };

    // Kh·ªüi t·∫°o
    calculateTotal();

    // X·ª≠ l√Ω s·ª± ki·ªán input cho c√°c field
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('so-luong') || e.target.classList.contains('don-gia')) {
            calculateTotal();
        }
    });
});
</script>

<style>
.ten-san-pham:focus, .danh-muc-input:focus, .don-vi-tinh-input:focus, .so-luong:focus, .don-gia:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}
.product-row {
    transition: all 0.3s ease;
}
.product-row:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 8px 0;
}
.remove-product {
    width: 32px;
    height: 32px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.remove-product i {
    font-size: 14px;
}
</style>
{% endblock %}
{{ block.super }}