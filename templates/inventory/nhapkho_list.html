{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Danh s√°ch nh·∫≠p kho{% endblock %}
{% block page_title %}üì• Danh s√°ch phi·∫øu nh·∫≠p kho{% endblock %}

{% block content %}
<div class="card table-custom h-100">
    <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
        <h5 class="card-title mb-0"><i class="fas fa-clipboard-list me-2"></i>Phi·∫øu nh·∫≠p kho</h5>
        <a href="{% url 'inventory:nhap_kho_create' %}" class="btn btn-primary">
            <i class="fas fa-plus-circle me-2"></i>T·∫°o phi·∫øu nh·∫≠p
        </a>
    </div>
    <div class="card-body d-flex flex-column p-0">
        <!-- B·ªô l·ªçc v√† t√¨m ki·∫øm -->
        <div class="bg-light p-3 border-bottom">
            <form method="GET" action="" class="row g-2 align-items-center">
                <div class="col-md-3 col-sm-6">
                    <label class="form-label small text-muted mb-1">T·ª´ ng√†y</label>
                    <input type="date" name="start_date" class="form-control form-control-sm"
                           value="{{ start_date|default:'' }}">
                </div>
                <div class="col-md-3 col-sm-6">
                    <label class="form-label small text-muted mb-1">ƒê·∫øn ng√†y</label>
                    <input type="date" name="end_date" class="form-control form-control-sm"
                           value="{{ end_date|default:'' }}">
                </div>
                <div class="col-md-4 col-sm-8">
                    <label class="form-label small text-muted mb-1">T√¨m ki·∫øm</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" name="q" class="form-control"
                               value="{{ search_query|default:'' }}"
                               placeholder="M√£ phi·∫øu, nh√† cung c·∫•p...">
                    </div>
                </div>
                <div class="col-md-2 col-sm-4">
                    <button type="submit" class="btn btn-dark btn-sm w-100 mt-4">
                        <i class="fas fa-filter me-1"></i>L·ªçc
                    </button>
                </div>
            </form>
        </div>

        <!-- Th√¥ng b√°o t√¨m ki·∫øm -->
        {% if search_query or start_date or end_date %}
        <div class="alert alert-info m-3 mb-2 py-2 d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-info-circle me-2"></i>
                <span class="fw-bold">ƒêang l·ªçc:</span>
                {% if search_query %}<span class="badge bg-primary ms-2">{{ search_query }}</span>{% endif %}
                {% if start_date %}<span class="badge bg-secondary ms-2">T·ª´: {{ start_date }}</span>{% endif %}
                {% if end_date %}<span class="badge bg-secondary ms-2">ƒê·∫øn: {{ end_date }}</span>{% endif %}
                <span class="badge bg-success ms-2">S·ªë phi·∫øu: {{ phieu_nhap|length }}</span>
            </div>
            <a href="{% url 'inventory:nhapkho_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-times me-1"></i>X√≥a l·ªçc
            </a>
        </div>
        {% endif %}

        <!-- B·∫£ng danh s√°ch phi·∫øu nh·∫≠p -->
        <div class="table-responsive flex-grow-1">
            <table class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="ps-3">M√£ phi·∫øu</th>
                        <th>Ng√†y nh·∫≠p</th>
                        <th>Nh√† cung c·∫•p</th>
                        <th class="text-center">S·ªë SP</th>
                        <th class="text-end pe-3">T·ªïng ti·ªÅn</th>
                        <th>Ng∆∞·ªùi l·∫≠p</th>
                        <th class="text-center">Tr·∫°ng th√°i</th>
                        <th class="text-center pe-3" width="180">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    {% for phieu in phieu_nhap %}
                    <tr>
                        <td class="ps-3">
                            <div class="fw-bold text-primary">{{ phieu.ma_phieu }}</div>
                        </td>
                        <td>
                            <div>{{ phieu.ngay_nhap|date:"d/m/Y" }}</div>
                            <small class="text-muted">{{ phieu.ngay_nhap|date:"H:i" }}</small>
                        </td>
                        <td>
                            <div class="fw-bold">{{ phieu.nha_cung_cap.ten_nha_cung_cap|truncatechars:20 }}</div>
                            {% if phieu.nha_cung_cap.dien_thoai %}
                            <small class="text-muted">
                                <i class="fas fa-phone fa-xs me-1"></i>{{ phieu.nha_cung_cap.dien_thoai }}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-info">
                                {{ phieu.chi_tiet_nhap.count }} SP
                            </span>
                        </td>
                        <td class="text-end pe-3 fw-bold text-success">
                            {{ phieu.tong_tien|floatformat:0|intcomma }}‚Ç´
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                     style="width: 32px; height: 32px;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <div class="small fw-bold">{{ phieu.nguoi_lap.username }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-success">
                                <i class="fas fa-check me-1"></i>Ho√†n th√†nh
                            </span>
                        </td>
                        <td class="text-center pe-3">
                            <div class="d-flex justify-content-center gap-2">
                                <!-- N√∫t Xem chi ti·∫øt -->
                                <a href="{% url 'inventory:nhap_kho_detail' phieu.pk %}"
                                   class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center action-btn"
                                   data-bs-toggle="tooltip" title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i>
                                </a>

                                <!-- N√∫t In phi·∫øu -->
                                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center justify-content-center action-btn"
                                        onclick="printInvoice('{{ phieu.ma_phieu }}')"
                                        data-bs-toggle="tooltip" title="In phi·∫øu">
                                    <i class="fas fa-print"></i>
                                </button>

                                <!-- N√∫t X√≥a phi·∫øu -->
                                <form action="{% url 'inventory:xoa_phieu_nhap' phieu.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center action-btn"
                                            onclick="return confirmDelete('{{ phieu.ma_phieu }}')"
                                            data-bs-toggle="tooltip" title="X√≥a phi·∫øu">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="empty-state">
                                <div class="empty-state-icon mb-3">
                                    <i class="fas fa-inbox fa-3x text-muted"></i>
                                </div>
                                <h4 class="text-muted mb-2">
                                    {% if search_query or start_date or end_date %}
                                    Kh√¥ng t√¨m th·∫•y phi·∫øu nh·∫≠p
                                    {% else %}
                                    Ch∆∞a c√≥ phi·∫øu nh·∫≠p kho n√†o
                                    {% endif %}
                                </h4>
                                <p class="text-muted mb-4">
                                    {% if search_query or start_date or end_date %}
                                    Kh√¥ng c√≥ k·∫øt qu·∫£ ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán t√¨m ki·∫øm
                                    {% else %}
                                    H√£y t·∫°o phi·∫øu nh·∫≠p kho ƒë·∫ßu ti√™n ƒë·ªÉ qu·∫£n l√Ω h√†ng h√≥a
                                    {% endif %}
                                </p>
                                {% if search_query or start_date or end_date %}
                                <a href="{% url 'inventory:danh_sach_nhap' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i>X√≥a b·ªô l·ªçc
                                </a>
                                {% else %}
                                <a href="{% url 'inventory:nhap_kho_create' %}" class="btn btn-primary">
                                    <i class="fas fa-plus-circle me-2"></i>T·∫°o phi·∫øu nh·∫≠p ƒë·∫ßu ti√™n
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Ph√¢n trang -->
        {% if is_paginated %}
        <div class="card-footer bg-white border-top py-3">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if search_query %}&q={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-angle-left"></i></span>
                    </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&q={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-angle-right"></i></span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<style>
/* Card styling */
.card {
    border: none;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
    border-radius: 0.5rem;
    overflow: hidden;
}

.card-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1rem 1.5rem;
}

/* Table styling */
.table {
    margin-bottom: 0;
    font-size: 0.9rem;
}

.table thead th {
    font-weight: 600;
    padding: 0.75rem 0.5rem;
    vertical-align: middle;
    border-bottom: 2px solid #dee2e6;
}

.table tbody td {
    padding: 0.75rem 0.5rem;
    vertical-align: middle;
    border-bottom: 1px solid #f0f0f0;
}

.table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

/* N√∫t thao t√°c - K√çCH TH∆Ø·ªöC B·∫∞NG NHAU */
.action-btn {
    width: 36px !important;
    height: 36px !important;
    padding: 0 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border-radius: 0.375rem !important;
    border-width: 1px !important;
    transition: all 0.2s !important;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* M√†u s·∫Øc n√∫t */
.btn-outline-primary {
    color: #4e73df;
    border-color: #4e73df;
}

.btn-outline-primary:hover {
    background-color: #4e73df;
    color: white;
}

.btn-outline-secondary {
    color: #6c757d;
    border-color: #6c757d;
}

.btn-outline-secondary:hover {
    background-color: #6c757d;
    color: white;
}

.btn-outline-danger {
    color: #e74a3b;
    border-color: #e74a3b;
}

.btn-outline-danger:hover {
    background-color: #e74a3b;
    color: white;
}

/* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
.gap-2 {
    gap: 0.5rem;
}

/* Badge styling */
.badge {
    font-weight: 500;
    padding: 0.35em 0.65em;
    font-size: 0.75em;
}

/* Empty state */
.empty-state {
    padding: 3rem 1rem;
}

.empty-state-icon {
    opacity: 0.5;
}

/* Form controls */
.form-control-sm {
    font-size: 0.875rem;
}

/* Pagination */
.pagination {
    margin-bottom: 0;
}

.page-link {
    border: 1px solid #dee2e6;
    color: #4e73df;
    padding: 0.375rem 0.75rem;
}

.page-item.active .page-link {
    background-color: #4e73df;
    border-color: #4e73df;
}

/* Responsive */
@media (max-width: 768px) {
    .card-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }

    .action-btn {
        width: 32px !important;
        height: 32px !important;
    }

    .table thead th,
    .table tbody td {
        padding: 0.5rem 0.25rem;
        font-size: 0.85rem;
    }

    .table tbody td:nth-child(3), /* Nh√† cung c·∫•p */
    .table tbody td:nth-child(6) { /* Ng∆∞·ªùi l·∫≠p */
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
}

@media (max-width: 576px) {
    .action-btn {
        width: 28px !important;
        height: 28px !important;
        font-size: 0.75rem;
    }

    .gap-2 {
        gap: 0.25rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // K√≠ch ho·∫°t tooltip Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh cho b·ªô l·ªçc
    const today = new Date().toISOString().split('T')[0];
    const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];

    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');

    if (startDateInput && !startDateInput.value) {
        startDateInput.value = firstDayOfMonth;
    }

    if (endDateInput && !endDateInput.value) {
        endDateInput.value = today;
    }

    // Thi·∫øt l·∫≠p ng√†y t·ªëi ƒëa cho end_date l√† h√¥m nay
    if (endDateInput) {
        endDateInput.max = today;
    }
});

// H√†m x√°c nh·∫≠n x√≥a
function confirmDelete(maPhieu) {
    return confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a phi·∫øu nh·∫≠p "${maPhieu}"?\n\nL∆∞u √Ω: H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`);
}

// H√†m in phi·∫øu
function printInvoice(maPhieu) {
    alert(`Ch·ª©c nƒÉng in phi·∫øu ${maPhieu} ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.`);
    // window.open(`/inventory/nhap-kho/${maPhieu}/print/`, '_blank');
}
</script>
{% endblock %}